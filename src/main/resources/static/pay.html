<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Pay (Compliance Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background-color: #0f172a; color: white; font-family: sans-serif; }</style>
</head>
<body class="flex justify-center items-center min-h-screen">

    <div class="w-full max-w-sm bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-2xl">
        <div class="text-center mb-8">
            <h2 class="text-xl font-bold text-slate-200">Secure Payment</h2>
            <div class="text-xs text-slate-500 mt-1">BANK-GRADE ENCRYPTION ENABLED</div>
        </div>

        <div class="mb-6">
            <label class="text-xs text-slate-400">Receiver ID</label>
            <input type="text" id="receiver" value="Uber_Driver_Raj" class="w-full bg-slate-800 text-white rounded p-2 mt-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
        </div>

        <div class="mb-8 text-center">
            <span class="text-slate-500 text-2xl">‚Çπ</span>
            <input type="number" id="amount" value="5000" class="bg-transparent text-5xl font-bold text-center w-40 focus:outline-none text-white">
        </div>

        <button onclick="pay()" id="btn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold text-lg transition-colors">
            AUTHORIZE PAYMENT
        </button>

        <div id="logs" class="mt-6 text-xs font-mono space-y-2 text-slate-400"></div>
    </div>

<script>
    async function pay() {
        const btn = document.getElementById('btn');
        const logs = document.getElementById('logs');
        
        btn.innerText = "VERIFYING IDENTITY...";
        btn.disabled = true;
        logs.innerHTML = `<div>üîí Generating Client ECDSA Signature...</div>`;

        // 1. SIMULATE CLIENT-SIDE SIGNING (In real app, use WebCrypto API)
        const mockSignature = "SIG_ECDSA_" + Math.random().toString(36).substring(2) + "." + Date.now();

        // 2. PREPARE COMPLIANCE PAYLOAD
        const payload = {
            transactionId: crypto.randomUUID(), // UUID v4
            fromAccount: "ACC-MUM-001",
            toAccount: document.getElementById('receiver').value,
            amount: parseFloat(document.getElementById('amount').value),
            currency: "INR",
            timestamp: new Date().toISOString(),
            deviceId: "DEVICE-WEB-01",
            location: { // NESTED OBJECT (Fixes the issue)
                lat: 19.0760,
                lon: 72.8777
            },
            ipAddress: "127.0.0.1",
            clientSignature: mockSignature // MANDATORY FIELD
        };

        try {
            // Simulate network delay for realism
            await new Promise(r => setTimeout(r, 800));

            const res = await fetch('/api/v1/compliance/transaction', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            const data = await res.json(); 

            if (res.ok) {
                btn.style.backgroundColor = "#10b981";
                btn.innerText = "PAYMENT SEALED";
                
                logs.innerHTML += `<div class="text-green-400 mt-2">‚úÖ APPROVED</div>`;
                logs.innerHTML += `<div>Policy: <span class="text-white">${data.signatures.server}</span></div>`;
                logs.innerHTML += `<div>Ledger ID: <span class="text-blue-400">#${data.ledger_id}</span></div>`;
            } else {
                btn.style.backgroundColor = "#ef4444";
                btn.innerText = "DECLINED";
                logs.innerHTML += `<div class="text-red-400 mt-2">‚ùå ${data.reason || "Policy Violation"}</div>`;
                if(data.flags) logs.innerHTML += `<div class="text-yellow-500">Flags: ${data.flags}</div>`;
            }
        } catch (e) {
            console.error(e);
            btn.innerText = "NETWORK ERROR";
            btn.style.backgroundColor = "#f59e0b";
            logs.innerHTML += `<div class="text-red-500">‚ö†Ô∏è Connection Failed</div>`;
        }

        // Reset
        setTimeout(() => { 
            if(btn.innerText !== "DECLINED") {
                btn.innerText = "AUTHORIZE PAYMENT"; 
                btn.style.backgroundColor = "#2563eb"; 
                btn.disabled = false;
            }
        }, 5000);
    }
</script>
</body>
</html>