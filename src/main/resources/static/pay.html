<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Pay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>body { background-color: #000; color: white; font-family: 'Inter', sans-serif; }</style>
</head>
<body class="flex justify-center items-center min-h-screen bg-gray-900">

    <div class="w-full max-w-sm bg-black border border-gray-800 rounded-3xl p-6 relative overflow-hidden">
        <div class="flex justify-between text-xs text-gray-500 mb-6">
            <span>SHADOW NETWORK</span>
            <span id="gpsStatus">üì° GPS: LOCATING...</span>
        </div>

        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto mb-2 flex items-center justify-center text-2xl font-bold">R</div>
            <h2 class="text-xl font-bold">Pay Receiver</h2>
            <input type="text" id="receiver" value="Uber_Driver_Raj" class="bg-gray-800 text-center text-sm rounded p-1 w-full mt-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
        </div>

        <div class="mb-8 text-center">
            <span class="text-gray-500 text-2xl">‚Çπ</span>
            <input type="number" id="amount" value="200" class="bg-transparent text-5xl font-bold text-center w-32 focus:outline-none">
        </div>

        <button onclick="pay()" id="btn" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-lg active:scale-95 transition-transform">
            SWIPE TO PAY
        </button>

        <div id="logs" class="mt-6 text-xs text-gray-400 space-y-1 hidden"></div>
    </div>

<script>
    let userLoc = { lat: 12.9716, lon: 77.5946 }; // Default Bangalore

    // 1. Get Real GPS
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            document.getElementById('gpsStatus').innerText = "‚úÖ GPS LOCKED";
            document.getElementById('gpsStatus').classList.add("text-green-500");
        });
    }

    async function pay() {
        const btn = document.getElementById('btn');
        const logs = document.getElementById('logs');
        
        btn.innerText = "ANALYZING RISK...";
        btn.classList.add("opacity-50");
        logs.classList.remove("hidden");
        logs.innerHTML = "<div>üîÑ Connecting to AI Sentinel...</div>";

        // FIX: Payload MUST match PaymentRequest.kt
        const payload = {
            accountId: "ACC-MUM-001", 
            paymentInstrumentId: "DEVICE-ID-99", 
            toAccount: document.getElementById('receiver').value,
            amount: parseFloat(document.getElementById('amount').value),
            currentLat: userLoc.lat,
            currentLon: userLoc.lon,
            ipAddress: "192.168.1.105"
        };

        try {
            const res = await fetch('/api/v1/audit/payment', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-API-KEY': 'shadow-secret-key-123'
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (res.ok) {
                btn.style.backgroundColor = "#10b981"; // Green
                btn.innerText = "PAYMENT SEALED";
                logs.innerHTML += `<div class="text-green-400">‚úÖ APPROVED: ${data.strategy}</div>`;
                if (data.risk !== undefined) {
                     logs.innerHTML += `<div class="text-xs text-gray-500">Risk Score: ${data.risk}</div>`;
                }
            } else {
                btn.style.backgroundColor = "#ef4444"; // Red
                btn.innerText = "BLOCKED";
                
                let reason = "Unknown Error";
                if (data.reasons) reason = data.reasons;
                else if (data.errors) reason = JSON.stringify(data.errors);
                else if (data.message) reason = data.message;
                
                logs.innerHTML += `<div class="text-red-400">‚ùå BLOCKED: ${reason}</div>`;
            }
        } catch (e) {
            console.error(e);
            btn.innerText = "ERROR";
            logs.innerHTML += `<div class="text-red-500">‚ö†Ô∏è Network Error (Check Server Console)</div>`;
        }

        setTimeout(() => { 
            if(btn.innerText !== "BLOCKED") {
                btn.innerText = "SWIPE TO PAY"; 
                btn.style.backgroundColor = "#2563eb"; 
                btn.classList.remove("opacity-50"); 
            }
        }, 4000);
    }
</script>
</body>
</html>