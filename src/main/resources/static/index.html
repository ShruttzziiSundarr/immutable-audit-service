<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHADOW LEDGER | Sentinel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: '#111111',
                            border: '#333333',
                            primary: '#00ff9d', // Neon Green
                            danger: '#ff003c',  // Neon Red
                            dim: '#888888'
                        }
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #e0e0e0; font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background: rgba(17, 17, 17, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid #333;
        }
        .glow-text { text-shadow: 0 0 10px rgba(0, 255, 157, 0.5); }
    </style>
</head>
<body class="min-h-screen p-6 selection:bg-cyber-primary selection:text-black">

    <nav class="flex justify-between items-center mb-10 border-b border-cyber-border pb-4">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-cyber-primary rounded-full animate-pulse"></div>
            <h1 class="text-2xl font-bold tracking-wider text-white">SHADOW<span class="text-cyber-primary">LEDGER</span></h1>
        </div>
        <div class="text-cyber-dim text-sm">
            STATUS: <span class="text-cyber-primary">ONLINE</span> | MODE: <span class="text-yellow-400">TSA_STRATEGY</span>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel rounded-xl p-6 shadow-2xl">
                <h2 class="text-lg font-bold mb-4 text-cyber-primary uppercase border-b border-cyber-border pb-2">Integrity Check</h2>
                <p class="text-xs text-cyber-dim mb-4">Cryptographic proof validation engine.</p>
                
                <div class="relative">
                    <input type="number" id="txInput" placeholder="Transaction ID (e.g. 40)" 
                        class="w-full bg-black border border-cyber-border rounded p-3 text-white focus:border-cyber-primary focus:outline-none transition-colors">
                </div>
                
                <button onclick="verifyTransaction()" 
                    class="w-full mt-4 bg-cyber-primary text-black font-bold py-3 rounded hover:bg-white transition-all transform active:scale-95 uppercase tracking-widest">
                    Verify Integrity
                </button>

                <div id="verifyResult" class="mt-6 p-4 rounded bg-black/50 border border-cyber-border hidden min-h-[60px] flex items-center justify-center text-center text-sm">
                </div>
            </div>

            <div class="glass-panel rounded-xl p-6">
                <h2 class="text-sm font-bold text-cyber-dim mb-2 uppercase">System Metrics</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-black/40 p-3 rounded border border-cyber-border">
                        <div class="text-xs text-cyber-dim">Total Blocks</div>
                        <div class="text-xl font-bold text-white" id="totalBlocks">--</div>
                    </div>
                    <div class="bg-black/40 p-3 rounded border border-cyber-border">
                        <div class="text-xs text-cyber-dim">Strategy</div>
                        <div class="text-xl font-bold text-cyber-primary">Hybrid</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            
            <div class="glass-panel rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-white">Block Velocity</h2>
                    <span class="text-xs px-2 py-1 bg-cyber-border rounded text-cyber-dim">Real-time</span>
                </div>
                <div class="h-48">
                    <canvas id="txChart"></canvas>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-6">
                <h2 class="text-lg font-bold text-white mb-4">Recent Blocks</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-cyber-dim">
                        <thead class="bg-cyber-border/30 text-xs uppercase text-white">
                            <tr>
                                <th class="p-3">Height</th>
                                <th class="p-3">Merkle Root (Hash)</th>
                                <th class="p-3">TX Count</th>
                                <th class="p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="blockTableBody" class="divide-y divide-cyber-border">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

<script>
    const API_URL = "/api/v1/audit";
    let chartInstance = null;

    // --- 1. SETUP CHART ---
    function initChart() {
        const ctx = document.getElementById('txChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Transactions',
                    data: [],
                    borderColor: '#00ff9d',
                    backgroundColor: 'rgba(0, 255, 157, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#333' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- 2. FETCH DATA ---
    async function fetchData() {
        try {
            const res = await fetch(`${API_URL}/blocks`);
            const blocks = await res.json();
            
            // Update Table
            const tbody = document.getElementById('blockTableBody');
            tbody.innerHTML = '';
            
            // Reverse to show newest first, but limit to 5 for UI
            const recent = blocks.slice(0, 5); 
            
            recent.forEach(block => {
                const row = `
                    <tr class="hover:bg-cyber-border/20 transition-colors">
                        <td class="p-3 font-bold text-cyber-primary">#${block.blockHeight}</td>
                        <td class="p-3 font-mono text-xs text-white opacity-70 truncate max-w-[200px]" title="${block.merkleRoot}">
                            ${block.merkleRoot.substring(0, 20)}...
                        </td>
                        <td class="p-3">${block.transactionCount}</td>
                        <td class="p-3"><span class="px-2 py-1 bg-green-900 text-green-300 text-xs rounded">SEALED</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update Stats
            if(blocks.length > 0) {
                document.getElementById('totalBlocks').innerText = blocks[0].blockHeight;
            }

            // Update Chart (Fake real-time feel by mapping block height to tx count)
            const labels = blocks.map(b => `#${b.blockHeight}`).reverse();
            const data = blocks.map(b => b.transactionCount).reverse();
            
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = data;
            chartInstance.update();

        } catch (e) {
            console.error("Connection lost", e);
        }
    }

    // --- 3. VERIFY FUNCTION ---
    async function verifyTransaction() {
        const id = document.getElementById('txInput').value;
        const resultDiv = document.getElementById('verifyResult');
        
        if(!id) return;

        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = '<span class="animate-pulse text-cyber-primary">Running Merkle Proof...</span>';

        try {
            const res = await fetch(`${API_URL}/verify/${id}`);
            if(res.ok) {
                resultDiv.innerHTML = `
                    <div class="text-cyber-primary">
                        <div class="text-xl">✅ VERIFIED</div>
                        <div class="text-xs text-white opacity-70">Proof Validated. Transaction is immutable.</div>
                    </div>`;
                resultDiv.className = "mt-6 p-4 rounded bg-green-900/20 border border-green-500 min-h-[60px] flex items-center justify-center text-center";
            } else {
                resultDiv.innerHTML = `
                    <div class="text-cyber-danger">
                        <div class="text-xl">❌ TAMPER DETECTED</div>
                        <div class="text-xs text-white opacity-70">Hash Mismatch. Integrity Compromised.</div>
                    </div>`;
                resultDiv.className = "mt-6 p-4 rounded bg-red-900/20 border border-red-500 min-h-[60px] flex items-center justify-center text-center";
            }
        } catch(e) {
            resultDiv.innerHTML = "Server Offline";
        }
    }

    // Start
    initChart();
    fetchData();
    setInterval(fetchData, 2000); // Live update
</script>
</body>
</html>